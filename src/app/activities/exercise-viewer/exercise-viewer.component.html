<div class="viewer-container">
  <div class="header-section">
    <button mat-icon-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-content">
      <p class="breadcrumb">
        {{ getCourseName() }} / {{ level?.toUpperCase() }} / {{ getActivityDisplayName() }}
      </p>
      <h1 class="exercise-title" *ngIf="exercise$ | async as exercise">
        {{ getExerciseDisplayTitle(exercise) }}
      </h1>
      <h1 class="exercise-title" *ngIf="!(exercise$ | async)">Exercise</h1>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading exercise...</p>
  </div>

  <div *ngIf="error" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="loadExercise()">
      Retry
    </button>
  </div>

  <div *ngIf="exercise$ | async as exercise" class="exercise-content">
    <!-- Grammar Tests -->
    <div *ngIf="isGrammarTest() && exercise.payload && exercise.payload.questions" class="grammar-test">
      <div *ngFor="let question of exercise.payload.questions; let i = index" class="question-block">
        <div class="question-header">
          <span class="question-number">{{ i + 1 }}</span>
          <div class="topic-badge" *ngIf="question.topic">
            {{ question.topic.name }}
          </div>
        </div>

        <p class="question-text">{{ question.text }}</p>

        <div class="choices">
          <div
            *ngFor="let choice of parseGrammarChoices(question.choices); let j = index"
            class="choice"
            [class.selected]="isGrammarChoiceSelected(question.id, choice)"
            [class.correct]="isGrammarAnswerCorrect(question.id, choice, question.solution)"
            [class.incorrect]="isGrammarAnswerIncorrect(question.id, choice, question.solution)"
            (click)="!showResults && selectGrammarAnswer(question.id, choice)"
          >
            <span class="choice-label">{{ getChoiceLabel(j) }}.</span>
            <span class="choice-text">{{ choice }}</span>
            <mat-icon *ngIf="showResults && choice === question.solution" class="check-icon">
              check_circle
            </mat-icon>
            <mat-icon *ngIf="showResults && isGrammarChoiceSelected(question.id, choice) && choice !== question.solution" class="error-icon">
              cancel
            </mat-icon>
          </div>
        </div>

        <div *ngIf="showResults && question.explanation" class="explanation">
          <mat-icon>lightbulb</mat-icon>
          <p>{{ question.explanation }}</p>
        </div>
      </div>
    </div>

    <!-- Speaking -->
    <div *ngIf="isSpeaking() && exercise.payload" class="speaking-exercise">
      <div *ngIf="exercise.payload.image" class="speaking-image">
        <img
          [src]="getSpeakingImageUrl(exercise.payload.image)"
          [alt]="'Speaking exercise image ' + exercise.payload.image"
          (error)="onImageError($event)"
        />
      </div>

      <div class="speaking-questions">
        <h3>Questions:</h3>
        <ol>
          <li *ngFor="let question of exercise.payload.questions">
            {{ question }}
          </li>
        </ol>
      </div>

      <div *ngIf="exercise.payload.notes" class="speaking-notes">
        <mat-icon>info</mat-icon>
        <p>{{ exercise.payload.notes }}</p>
      </div>
    </div>

    <!-- Writing - Essay C2 (two perspectives) -->
    <div *ngIf="isWriting() && exercise.payload?.title1 && exercise.payload?.title2" class="writing-essay">
      <div class="essay-perspectives">
        <div class="perspective-card">
          <h3>{{ exercise.payload.title1 }}</h3>
          <p>{{ exercise.payload.text1 }}</p>
        </div>

        <div class="perspective-card">
          <h3>{{ exercise.payload.title2 }}</h3>
          <p>{{ exercise.payload.text2 }}</p>
        </div>
      </div>

      <div class="writing-instructions">
        <mat-icon>edit</mat-icon>
        <p>Write an essay discussing both perspectives and give your own opinion. (Write 240-280 words)</p>
      </div>
    </div>

    <!-- Writing - Essay C1 (panel with opinions) -->
    <div *ngIf="isWriting() && exercise.payload?.headline && exercise.payload?.opinions" class="writing-essay-c1">
      <div *ngIf="exercise.payload.notice" class="essay-notice">
        <p>{{ exercise.payload.notice }}</p>
      </div>

      <div class="essay-headline">
        <h3>{{ exercise.payload.headline }}</h3>
      </div>

      <div *ngIf="exercise.payload.closure" class="essay-closure">
        <p>{{ exercise.payload.closure }}</p>
      </div>

      <div *ngIf="exercise.payload.opinions && exercise.payload.opinions.length > 0" class="essay-opinions">
        <div *ngFor="let opinion of exercise.payload.opinions" class="opinion-item">
          <mat-icon>format_quote</mat-icon>
          <p>{{ opinion }}</p>
        </div>
      </div>

      <div *ngIf="exercise.payload.points && exercise.payload.points.length > 0" class="essay-points">
        <h4>Points to consider:</h4>
        <ul>
          <li *ngFor="let point of exercise.payload.points">{{ point }}</li>
        </ul>
      </div>

      <div class="writing-instructions">
        <mat-icon>edit</mat-icon>
        <p>Write your essay discussing the points and giving your opinion. (Write 220-260 words)</p>
      </div>
    </div>

    <!-- Writing - Email B1 (email format with paragraphs) - MUST BE BEFORE GENERIC -->
    <div *ngIf="isWriting() && exercise.payload?.type === 'Email' && exercise.payload?.from && exercise.payload?.paragraphs && exercise.payload.paragraphs.length > 0" class="writing-email-b1">
      <div class="email-header">
        <div class="email-badge">
          <mat-icon>email</mat-icon>
          <span>{{ exercise.payload.type || 'Email' }}</span>
        </div>

        <div class="email-meta">
          <div class="email-from">
            <strong>From:</strong> {{ exercise.payload.from }}
          </div>
          <div *ngIf="exercise.payload.subject" class="email-subject">
            <strong>Subject:</strong> {{ exercise.payload.subject }}
          </div>
        </div>
      </div>

      <div class="email-body">
        <div *ngIf="exercise.payload.opening" class="email-opening">
          <p>{{ exercise.payload.opening }}</p>
        </div>

        <div class="email-paragraphs">
          <div *ngFor="let paragraph of exercise.payload.paragraphs" class="email-paragraph">
            <p class="paragraph-text">{{ paragraph.text }}</p>
            <span *ngIf="paragraph.note" class="paragraph-note">{{ paragraph.note }}</span>
          </div>
        </div>

        <div *ngIf="exercise.payload.closure" class="email-closure">
          <p>{{ exercise.payload.closure }}</p>
        </div>
      </div>

      <div class="writing-instructions">
        <mat-icon>edit</mat-icon>
        <p>Write your reply. (Write 100-120 words)</p>
      </div>
    </div>

    <!-- Writing - Article B1 -->
    <div *ngIf="isWriting() && exercise.payload?.type === 'Article' && exercise.payload?.notice && exercise.payload?.opening" class="writing-article-b1">
      <div class="article-notice">
        <mat-icon>info</mat-icon>
        <p>{{ exercise.payload.notice }}</p>
      </div>

      <div class="article-opening">
        <h3>{{ exercise.payload.opening }}</h3>
      </div>

      <div class="article-points" *ngIf="exercise.payload.points && exercise.payload.points.length > 0">
        <ul>
          <li *ngFor="let point of exercise.payload.points">{{ point }}</li>
        </ul>
      </div>

      <div class="article-closure" *ngIf="exercise.payload.closure">
        <p>{{ exercise.payload.closure }}</p>
      </div>

      <div class="writing-instructions">
        <mat-icon>edit</mat-icon>
        <p>Write your article. (Write 100-120 words)</p>
      </div>
    </div>

    <!-- Writing - Story B1 -->
    <div *ngIf="isWriting() && exercise.payload?.type === 'Story' && exercise.payload?.opening" class="writing-story-b1">
      <div class="story-headline" *ngIf="exercise.payload.headline">
        <mat-icon>menu_book</mat-icon>
        <p>{{ exercise.payload.headline }}</p>
      </div>

      <div class="story-opening">
        <p class="opening-text">{{ exercise.payload.opening }}</p>
      </div>

      <div class="writing-instructions">
        <mat-icon>edit</mat-icon>
        <p>Write your story. (Write 100-120 words)</p>
      </div>
    </div>

    <!-- Writing - Essay B2 (simple headline with points, NOT Report/Review/Letter/Article) -->
    <div *ngIf="isWriting() && exercise.payload?.headline && !exercise.payload?.opinions && exercise.payload?.points && !exercise.payload?.type" class="writing-essay-b2">
      <div *ngIf="exercise.payload.notice" class="essay-notice">
        <p>{{ exercise.payload.notice }}</p>
      </div>

      <div class="essay-headline">
        <h3>{{ exercise.payload.headline }}</h3>
      </div>

      <div class="essay-points">
        <h4>Your essay should include the following points:</h4>
        <ul>
          <li *ngFor="let point of exercise.payload.points">{{ point }}</li>
        </ul>
      </div>

      <div class="writing-instructions">
        <mat-icon>edit</mat-icon>
        <p>Write your essay. (Write 140-190 words)</p>
      </div>
    </div>

    <!-- Writing - Report/Review/Letter/Article (single text instruction) -->
    <div *ngIf="isWriting() && exercise.payload && !exercise.payload?.title1 && !exercise.payload?.opinions &&
                (exercise.payload.text || exercise.payload.notice || exercise.payload.subject || exercise.payload.points || exercise.payload.headline || exercise.payload.question || exercise.payload.topic || exercise.payload.point) &&
                exercise.payload.type !== 'Email' && exercise.payload.type !== 'Story' && !(exercise.payload.type === 'Article' && exercise.payload.opening && exercise.payload.points)" class="writing-report">
      <div class="report-type-badge">
        <mat-icon>description</mat-icon>
        <span>{{ exercise.payload.type || 'Writing Task' }}</span>
      </div>

      <!-- Prelude (para Letter B2) -->
      <div *ngIf="exercise.payload.prelude" class="report-prelude">
        <p>{{ exercise.payload.prelude }}</p>
      </div>

      <!-- Title (para Letter B2) -->
      <div *ngIf="exercise.payload.title" class="report-title">
        <h3>{{ exercise.payload.title }}</h3>
      </div>

      <!-- Notice (para Article, Review, Report, Letter) -->
      <div *ngIf="exercise.payload.notice" class="report-notice">
        <p>{{ exercise.payload.notice }}</p>
      </div>

      <!-- Subject (para Review/Proposal C1) -->
      <div *ngIf="exercise.payload.subject" class="report-subject">
        <h4>{{ exercise.payload.subject }}</h4>
      </div>

      <!-- Opening (para Article B2) -->
      <div *ngIf="exercise.payload.opening" class="report-opening">
        <p>{{ exercise.payload.opening }}</p>
      </div>

      <!-- Headline (para Report B2 como subtítulo "Your report should:") -->
      <div *ngIf="exercise.payload.headline" class="report-headline">
        <h4>{{ exercise.payload.headline }}</h4>
      </div>

      <!-- Topic (para Article) -->
      <div *ngIf="exercise.payload.topic" class="report-topic">
        <h3>{{ exercise.payload.topic }}</h3>
      </div>

      <!-- Info (para Article) -->
      <div *ngIf="exercise.payload.info" class="report-info">
        <p>{{ exercise.payload.info }}</p>
      </div>

      <!-- Question (para Review) -->
      <div *ngIf="exercise.payload.question" class="report-question">
        <h4>{{ exercise.payload.question }}</h4>
      </div>

      <!-- Points (lista de puntos para C1) -->
      <div *ngIf="exercise.payload.points && exercise.payload.points.length > 0" class="report-points-list">
        <div *ngFor="let point of exercise.payload.points; let i = index" class="point-item">
          <span class="point-number">{{ i + 1 }}</span>
          <p>{{ point }}</p>
        </div>
      </div>

      <!-- Instructions o Point -->
      <div *ngIf="exercise.payload.instructions || exercise.payload.point" class="report-instructions">
        <p>{{ exercise.payload.instructions || exercise.payload.point }}</p>
      </div>

      <!-- Text (para Report/Letter/Proposal simple) -->
      <div *ngIf="exercise.payload.text && !exercise.payload.points" class="report-instructions">
        <p>{{ exercise.payload.text }}</p>
      </div>

      <!-- Closure (texto final para C1) -->
      <div *ngIf="exercise.payload.closure" class="report-closure">
        <mat-icon>info</mat-icon>
        <p>{{ exercise.payload.closure }}</p>
      </div>

      <div class="writing-instructions">
        <mat-icon>edit</mat-icon>
        <p *ngIf="exercise.level === 'b2'">Write 140-190 words.</p>
        <p *ngIf="exercise.level !== 'b2'">Write 220-260 words.</p>
      </div>
    </div>

    <!-- Writing - Generic (other types, exclude B1 Email, Article, Story, and nested payload structures) -->
    <div *ngIf="isWriting() && exercise.payload && !exercise.payload?.payload?.title1 && !exercise.payload?.payload?.text && exercise.payload?.type !== 'Email' && exercise.payload?.type !== 'Article' && exercise.payload?.type !== 'Story'" class="writing-exercise">
      <div *ngIf="exercise.payload.opening" class="writing-section">
        <h3>Opening</h3>
        <p>{{ exercise.payload.opening }}</p>
      </div>

      <div *ngIf="exercise.payload.subject" class="writing-section">
        <h3>Subject</h3>
        <p>{{ exercise.payload.subject }}</p>
      </div>

      <div *ngIf="exercise.payload.paragraphs && exercise.payload.paragraphs.length > 0" class="writing-section">
        <h3>Paragraphs</h3>
        <ol>
          <li *ngFor="let paragraph of exercise.payload.paragraphs">
            {{ paragraph }}
          </li>
        </ol>
      </div>

      <div *ngIf="exercise.payload.points && exercise.payload.points.length > 0" class="writing-section">
        <h3>Key Points</h3>
        <ul>
          <li *ngFor="let point of exercise.payload.points">
            {{ point }}
          </li>
        </ul>
      </div>

      <div *ngIf="exercise.payload.closure" class="writing-section">
        <h3>Closure</h3>
        <p>{{ exercise.payload.closure }}</p>
      </div>
    </div>

    <!-- Matching (People with options) -->
    <div *ngIf="exercise.payload && exercise.payload.people && exercise.payload.texts" class="matching-exercise">
      <!-- Título del ejercicio -->
      <div *ngIf="exercise.payload.title" class="exercise-intro">
        <h2>{{ exercise.payload.title }}</h2>
      </div>

      <!-- Lista de opciones disponibles (textos/películas/etc) -->
      <div class="matching-options">
        <h3>Options:</h3>
        <div class="options-grid">
          <div *ngFor="let text of exercise.payload.texts" class="option-card">
            <h4>{{ text.title }}</h4>
            <p>{{ text.text }}</p>
          </div>
        </div>
      </div>

      <!-- Personas con selectores -->
      <div class="matching-people">
        <h3>Match each person with the most suitable option:</h3>
        <div *ngFor="let person of exercise.payload.people; let i = index" class="person-item">
          <div class="person-header">
            <span class="person-number">{{ i + 1 }}</span>
            <strong>{{ person.name }}</strong>
          </div>
          <p class="person-description">{{ person.text }}</p>

          <!-- Selector de respuesta -->
          <div class="answer-selector">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Select option</mat-label>
              <mat-select
                [(value)]="userAnswers[person.name]"
                [disabled]="showResults"
                (selectionChange)="selectMatchingAnswer(person.name, $event.value)"
              >
                <mat-option [value]="null">-- None --</mat-option>
                <mat-option
                  *ngFor="let text of exercise.payload.texts"
                  [value]="text.title"
                  [disabled]="isMatchingOptionUsed(text.title, person.name)"
                >
                  {{ text.title }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Feedback de respuesta -->
            <div *ngIf="showResults" class="answer-feedback">
              <mat-icon *ngIf="isCorrectMatchingAnswer(person.name, exercise.payload.solutions)" class="correct-icon">
                check_circle
              </mat-icon>
              <mat-icon *ngIf="!isCorrectMatchingAnswer(person.name, exercise.payload.solutions)" class="incorrect-icon">
                cancel
              </mat-icon>
              <span *ngIf="!isCorrectMatchingAnswer(person.name, exercise.payload.solutions)" class="correct-answer-text">
                Correct: {{ getCorrectMatchingSolution(person.name, exercise.payload.solutions) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults" class="results-summary">
        <mat-icon>{{ getCorrectMatchingCount(exercise.payload.solutions) === exercise.payload.people.length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getCorrectMatchingCount(exercise.payload.solutions) }}</strong> out of
          <strong>{{ exercise.payload.people.length }}</strong> correct!
        </p>
      </div>
    </div>

    <!-- Listening Extracts (audio con preguntas y opciones múltiples) -->
    <div *ngIf="exercise.payload.audio && exercise.payload.questions && exercise.payload.choices && exercise.payload.headline && exercise.payload.headline.includes('//')" class="extracts-section">
      <!-- Reproductor de audio -->
      <div class="audio-player">
        <audio controls [src]="exercise.payload.audio">
          Your browser does not support the audio element.
        </audio>
      </div>

      <!-- Preguntas agrupadas por extractos -->
      <h3>Questions</h3>
      <ng-container *ngFor="let group of groupQuestionsByExtracts(exercise.payload.questions, exercise.payload.headline)">
        <!-- Mostrar extracto antes de sus preguntas correspondientes -->
        <div *ngIf="group.extract" class="extract-description">
          <mat-icon>headphones</mat-icon>
          <p>{{ group.extract }}</p>
        </div>

        <!-- Preguntas del grupo -->
        <div *ngFor="let key of group.questionKeys" class="question-item">
          <p class="question">
            <strong>{{ key }}.</strong> {{ exercise.payload.questions[key] }}
          </p>

          <!-- Selector de respuesta interactivo con opciones múltiples -->
          <div class="answer-selector vertical">
            <button
              *ngFor="let choice of getExtractChoices(exercise.payload.choices[key]); let i = index"
              mat-stroked-button
              [color]="userAnswers[key] === choice ? 'primary' : ''"
              [class.selected]="userAnswers[key] === choice && !showResults"
              [class.correct]="showResults && userAnswers[key] === choice && isCorrectAnswer(key, exercise.payload.solutions)"
              [class.incorrect]="showResults && userAnswers[key] === choice && !isCorrectAnswer(key, exercise.payload.solutions)"
              [disabled]="showResults"
              (click)="selectAnswer(key, choice)"
            >
              <span class="choice-label">{{ getChoiceLabel(i) }}.</span>
              <span class="choice-text">{{ choice }}</span>
            </button>
          </div>

          <!-- Mostrar respuesta correcta si está mal -->
          <div *ngIf="showResults && !isCorrectAnswer(key, exercise.payload.solutions) && exercise.payload.solutions && exercise.payload.solutions[key]" class="correct-answer">
            <mat-icon>info</mat-icon>
            <span>Correct answer: {{ exercise.payload.solutions[key] }}</span>
          </div>
        </div>
      </ng-container>

      <!-- Resultados -->
      <div *ngIf="showResults && exercise.payload.solutions" class="results-summary">
        <mat-icon>{{ getCorrectCount(exercise.payload.solutions) === getObjectKeys(exercise.payload.questions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getCorrectCount(exercise.payload.solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.questions).length }}</strong> correct!
        </p>
      </div>

      <!-- Fallback: mostrar JSON crudo si no encaja en ningún patrón -->
      <details class="raw-data" *ngIf="isAdmin">
        <summary>View Raw Data</summary>
        <pre>{{ formatJson(exercise.payload) }}</pre>
      </details>
    </div>

    <!-- Listening Gapped Text (audio + texto con huecos para rellenar) -->
    <div *ngIf="exercise.payload.audio && exercise.payload.text && exercise.payload.solutions && !exercise.payload.questions" class="gapped-text-section">
      <!-- Instrucciones -->
      <div *ngIf="exercise.payload.headline" class="instructions">
        <mat-icon>info</mat-icon>
        <p>{{ exercise.payload.headline }}</p>
      </div>

      <!-- Reproductor de audio -->
      <div class="audio-player">
        <audio controls [src]="exercise.payload.audio">
          Your browser does not support the audio element.
        </audio>
      </div>

      <!-- Texto con huecos para completar -->
      <div class="gapped-text-content">
        <ng-container *ngFor="let line of gappedTextLines">
          <p class="text-line">
            <ng-container *ngFor="let segment of line.segments">
              <span *ngIf="segment.type === 'text'">{{ segment.content }}</span>
              <span *ngIf="segment.type === 'gap'" class="gap-input-wrapper">
                <span class="gap-number">({{ segment.gapNumber }})</span>
                <input
                  type="text"
                  class="gap-input"
                  [class.correct]="showResults && isGapCorrect(segment.gapNumber, exercise.payload.solutions)"
                  [class.incorrect]="showResults && userAnswers[segment.gapNumber] && !isGapCorrect(segment.gapNumber, exercise.payload.solutions)"
                  [(ngModel)]="userAnswers[segment.gapNumber]"
                  [disabled]="showResults"
                  placeholder="..........."
                />
                <!-- Mostrar respuesta correcta si está mal -->
                <span *ngIf="showResults && userAnswers[segment.gapNumber] && !isGapCorrect(segment.gapNumber, exercise.payload.solutions)" class="correct-answer-hint">
                  ✓ {{ exercise.payload.solutions[segment.gapNumber] }}
                </span>
              </span>
            </ng-container>
          </p>
        </ng-container>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults && exercise.payload.solutions" class="results-summary">
        <mat-icon>{{ getGappedTextCorrectCount(exercise.payload.solutions) === getObjectKeys(exercise.payload.solutions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getGappedTextCorrectCount(exercise.payload.solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.solutions).length }}</strong> correct!
        </p>
      </div>

      <!-- Raw data para admin -->
      <details class="raw-data" *ngIf="isAdmin">
        <summary>View Raw Data</summary>
        <pre>{{ formatJson(exercise.payload) }}</pre>
      </details>
    </div>

    <!-- Listening Multiple Choice (audio + preguntas con opciones múltiples A, B, C, D) -->
    <div *ngIf="exercise.payload.audio && exercise.payload.questions && exercise.payload.choices && (!exercise.payload.headline || !exercise.payload.headline.includes('//')) && !exercise.payload.base_file_path" class="multiple-choice-section">
      <!-- Instrucciones -->
      <div *ngIf="exercise.payload.headline" class="instructions">
        <mat-icon>info</mat-icon>
        <p>{{ exercise.payload.headline }}</p>
      </div>

      <!-- Reproductor de audio -->
      <div class="audio-player">
        <audio controls [src]="exercise.payload.audio">
          Your browser does not support the audio element.
        </audio>
      </div>

      <!-- Preguntas -->
      <h3>Questions</h3>
      <div *ngFor="let key of getObjectKeys(exercise.payload.questions)" class="question-item">
        <p class="question">
          <strong>{{ key }}.</strong> {{ exercise.payload.questions[key] }}
        </p>

        <!-- Opciones múltiples (A, B, C, D) -->
        <div class="answer-selector vertical">
          <button
            *ngFor="let choice of getExtractChoices(exercise.payload.choices[key]); let i = index"
            mat-stroked-button
            [color]="userAnswers[key] === choice ? 'primary' : ''"
            [class.selected]="userAnswers[key] === choice && !showResults"
            [class.correct]="showResults && userAnswers[key] === choice && isCorrectAnswer(key, exercise.payload.solutions)"
            [class.incorrect]="showResults && userAnswers[key] === choice && !isCorrectAnswer(key, exercise.payload.solutions)"
            [disabled]="showResults"
            (click)="selectAnswer(key, choice)"
          >
            <span class="choice-label">{{ getChoiceLabel(i) }}.</span>
            <span class="choice-text">{{ choice }}</span>
          </button>
        </div>

        <!-- Mostrar respuesta correcta si está mal -->
        <div *ngIf="showResults && !isCorrectAnswer(key, exercise.payload.solutions) && exercise.payload.solutions && exercise.payload.solutions[key]" class="correct-answer">
          <mat-icon>info</mat-icon>
          <span>Correct answer: {{ exercise.payload.solutions[key] }}</span>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults && exercise.payload.solutions" class="results-summary">
        <mat-icon>{{ getCorrectCount(exercise.payload.solutions) === getObjectKeys(exercise.payload.questions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getCorrectCount(exercise.payload.solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.questions).length }}</strong> correct!
        </p>
      </div>

      <!-- Raw data para admin -->
      <details class="raw-data" *ngIf="isAdmin">
        <summary>View Raw Data</summary>
        <pre>{{ formatJson(exercise.payload) }}</pre>
      </details>
    </div>

    <!-- Listening Pictures (audio + preguntas con opciones de imágenes) -->
    <div *ngIf="exercise.payload.audio && exercise.payload.base_file_path && exercise.payload.questions && exercise.payload.choices && exercise.payload.solutions" class="pictures-section">
      <!-- Instrucciones -->
      <div *ngIf="exercise.payload.headline" class="instructions">
        <mat-icon>info</mat-icon>
        <p>{{ exercise.payload.headline }}</p>
      </div>

      <!-- Reproductor de audio -->
      <div class="audio-player">
        <audio controls [src]="exercise.payload.audio">
          Your browser does not support the audio element.
        </audio>
      </div>

      <!-- Preguntas con imágenes -->
      <div class="questions-container">
        <div *ngFor="let key of getObjectKeys(exercise.payload.questions)" class="picture-question">
          <div class="question-header">
            <span class="question-number">{{ key }}</span>
            <p class="question-text">{{ exercise.payload.questions[key] }}</p>
          </div>

          <!-- Opciones de imágenes -->
          <div class="picture-choices">
            <div
              *ngFor="let imageKey of getPictureChoices(exercise.payload.choices[key])"
              class="picture-option"
              [class.selected]="userAnswers[key] === imageKey"
              [class.correct]="showResults && exercise.payload.solutions[key] === imageKey"
              [class.incorrect]="showResults && userAnswers[key] === imageKey && exercise.payload.solutions[key] !== imageKey"
              (click)="!showResults && selectPictureAnswer(key, imageKey)"
            >
              <img [src]="getPictureUrl(exercise.payload.base_file_path, imageKey)" [alt]="'Option ' + imageKey">
              <div class="picture-label">{{ getPictureLabel(imageKey) }}</div>
            </div>
          </div>

          <!-- Feedback -->
          <div *ngIf="showResults" class="feedback">
            <div *ngIf="userAnswers[key] === exercise.payload.solutions[key]" class="correct-feedback">
              <mat-icon>check_circle</mat-icon>
              <span>Correct!</span>
            </div>
            <div *ngIf="userAnswers[key] && userAnswers[key] !== exercise.payload.solutions[key]" class="incorrect-feedback">
              <mat-icon>cancel</mat-icon>
              <span>Incorrect. The correct answer is {{ getPictureLabel(exercise.payload.solutions[key]) }}.</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults" class="results-summary">
        <mat-icon>{{ getPicturesCorrectCount(exercise.payload.solutions) === getObjectKeys(exercise.payload.solutions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getPicturesCorrectCount(exercise.payload.solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.solutions).length }}</strong> correct!
        </p>
      </div>
    </div>

    <!-- Listening Matching (audio + matching de speakers con oraciones) -->
    <div *ngIf="exercise.payload.audio && exercise.payload.sentences && exercise.payload.solutions && !exercise.payload.sentences_1 && !exercise.payload.sentences_2 && !exercise.payload.base_file_path" class="matching-section">
      <!-- Instrucciones -->
      <div *ngIf="exercise.payload.headline" class="instructions">
        <mat-icon>info</mat-icon>
        <p>{{ exercise.payload.headline }}</p>
      </div>

      <!-- Reproductor de audio -->
      <div class="audio-player">
        <audio controls [src]="exercise.payload.audio">
          Your browser does not support the audio element.
        </audio>
      </div>

      <!-- Speakers con matching -->
      <div class="speakers-grid">
        <div *ngFor="let key of getObjectKeys(exercise.payload.solutions)" class="speaker-item">
          <h4>Speaker {{ key }}</h4>
          <mat-form-field appearance="outline">
            <mat-label>Select answer</mat-label>
            <mat-select [(value)]="userAnswers[key]" [disabled]="showResults">
              <mat-option *ngFor="let sentence of exercise.payload.sentences" [value]="sentence">
                {{ sentence }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Feedback -->
          <div *ngIf="showResults" class="feedback">
            <div *ngIf="userAnswers[key] === exercise.payload.solutions[key]" class="correct-feedback">
              <mat-icon>check_circle</mat-icon>
              <span>Correct!</span>
            </div>
            <div *ngIf="userAnswers[key] && userAnswers[key] !== exercise.payload.solutions[key]" class="incorrect-feedback">
              <mat-icon>cancel</mat-icon>
              <span>Incorrect. Correct answer: {{ exercise.payload.solutions[key] }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults && exercise.payload.solutions" class="results-summary">
        <mat-icon>{{ getCorrectCount(exercise.payload.solutions) === getObjectKeys(exercise.payload.solutions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getCorrectCount(exercise.payload.solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.solutions).length }}</strong> correct!
        </p>
      </div>
    </div>

    <!-- Listening Multiple Matching (audio + dos conjuntos de matching) -->
    <div *ngIf="exercise.payload.audio && exercise.payload.sentences_1 && exercise.payload.sentences_2 && exercise.payload.solutions_1 && exercise.payload.solutions_2" class="multiple-matching-section">
      <!-- Instrucciones -->
      <div *ngIf="exercise.payload.headline" class="instructions">
        <mat-icon>info</mat-icon>
        <p>{{ exercise.payload.headline }}</p>
      </div>

      <!-- Reproductor de audio -->
      <div class="audio-player">
        <audio controls [src]="exercise.payload.audio">
          Your browser does not support the audio element.
        </audio>
      </div>

      <!-- Primera tarea -->
      <div class="matching-task">
        <h3>Task 1</h3>
        <p class="subtitle" *ngIf="exercise.payload.subtitle_1">{{ exercise.payload.subtitle_1 }}</p>

        <div class="speakers-grid">
          <div *ngFor="let key of getObjectKeys(exercise.payload.solutions_1)" class="speaker-item">
            <h4>Speaker {{ key }}</h4>
            <mat-form-field appearance="outline">
              <mat-label>Select answer</mat-label>
              <mat-select [(value)]="userAnswers['task1_' + key]" [disabled]="showResults">
                <mat-option *ngFor="let sentence of exercise.payload.sentences_1" [value]="sentence">
                  {{ sentence }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Feedback -->
            <div *ngIf="showResults" class="feedback">
              <div *ngIf="userAnswers['task1_' + key] === exercise.payload.solutions_1[key]" class="correct-feedback">
                <mat-icon>check_circle</mat-icon>
                <span>Correct!</span>
              </div>
              <div *ngIf="userAnswers['task1_' + key] && userAnswers['task1_' + key] !== exercise.payload.solutions_1[key]" class="incorrect-feedback">
                <mat-icon>cancel</mat-icon>
                <span>Incorrect. Correct answer: {{ exercise.payload.solutions_1[key] }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Segunda tarea -->
      <div class="matching-task">
        <h3>Task 2</h3>
        <p class="subtitle" *ngIf="exercise.payload.subtitle_2">{{ exercise.payload.subtitle_2 }}</p>

        <div class="speakers-grid">
          <div *ngFor="let key of getObjectKeys(exercise.payload.solutions_2)" class="speaker-item">
            <h4>Speaker {{ key }}</h4>
            <mat-form-field appearance="outline">
              <mat-label>Select answer</mat-label>
              <mat-select [(value)]="userAnswers['task2_' + key]" [disabled]="showResults">
                <mat-option *ngFor="let sentence of exercise.payload.sentences_2" [value]="sentence">
                  {{ sentence }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Feedback -->
            <div *ngIf="showResults" class="feedback">
              <div *ngIf="userAnswers['task2_' + key] === exercise.payload.solutions_2[key]" class="correct-feedback">
                <mat-icon>check_circle</mat-icon>
                <span>Correct!</span>
              </div>
              <div *ngIf="userAnswers['task2_' + key] && userAnswers['task2_' + key] !== exercise.payload.solutions_2[key]" class="incorrect-feedback">
                <mat-icon>cancel</mat-icon>
                <span>Incorrect. Correct answer: {{ exercise.payload.solutions_2[key] }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults" class="results-summary">
        <mat-icon>{{ getMultipleMatchingCorrectCount(exercise.payload.solutions_1, exercise.payload.solutions_2) === (getObjectKeys(exercise.payload.solutions_1).length + getObjectKeys(exercise.payload.solutions_2).length) ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getMultipleMatchingCorrectCount(exercise.payload.solutions_1, exercise.payload.solutions_2) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.solutions_1).length + getObjectKeys(exercise.payload.solutions_2).length }}</strong> correct!
        </p>
      </div>
    </div>

    <!-- Key Word Transformations (sentences + keywords + challenges + solutions) -->
    <div *ngIf="!exercise.payload.audio && exercise.payload.compact_sentences && exercise.payload.compact_keywords && exercise.payload.compact_challenges && exercise.payload.compact_solutions" class="key-word-transformations-section">
      <div class="instructions">
        <mat-icon>info</mat-icon>
        <p>Complete the second sentence so that it has a similar meaning to the first sentence, using the word given. Do not change the word given. You must use between three and eight words, including the word given.</p>
      </div>

      <div class="transformations-container">
        <div *ngFor="let key of getObjectKeys(exercise.payload.compact_sentences)" class="transformation-item">
          <div class="question-number">{{ key }}</div>

          <!-- Oración original -->
          <div class="original-sentence">
            <p>{{ exercise.payload.compact_sentences[key] }}</p>
          </div>

          <!-- Palabra clave -->
          <div class="keyword-box">
            <span class="keyword-label">Key word:</span>
            <span class="keyword">{{ exercise.payload.compact_keywords[key] }}</span>
          </div>

          <!-- Oración a completar -->
          <div class="challenge-sentence">
            <p>{{ exercise.payload.compact_challenges[key] }}</p>
          </div>

          <!-- Campo de respuesta -->
          <div class="answer-input">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Your answer</mat-label>
              <input
                matInput
                [(ngModel)]="userAnswers[key]"
                [disabled]="showResults"
                placeholder="Type your answer here..."
              />
            </mat-form-field>
          </div>

          <!-- Feedback -->
          <div *ngIf="showResults" class="feedback">
            <div *ngIf="isKeyWordTransformationCorrect(key, exercise.payload.compact_solutions)" class="correct-feedback">
              <mat-icon>check_circle</mat-icon>
              <span>Correct!</span>
            </div>
            <div *ngIf="!isKeyWordTransformationCorrect(key, exercise.payload.compact_solutions)" class="incorrect-feedback">
              <mat-icon>cancel</mat-icon>
              <div class="incorrect-content">
                <span>Incorrect.</span>
                <span class="correct-answer-label">Correct answer(s):</span>
                <span class="correct-answer-value">{{ exercise.payload.compact_solutions[key] }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults" class="results-summary">
        <mat-icon>{{ getKeyWordTransformationsCorrectCount(exercise.payload.compact_solutions) === getObjectKeys(exercise.payload.compact_solutions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getKeyWordTransformationsCorrectCount(exercise.payload.compact_solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.compact_solutions).length }}</strong> correct!
        </p>
      </div>
    </div>

    <!-- Multiple Choice Cloze (texto con huecos numerados y opciones múltiples) -->
    <div *ngIf="!exercise.payload.audio && exercise.payload.text && exercise.payload.compact_choices && exercise.payload.compact_solutions && !exercise.payload.compact_keywords" class="multiple-choice-cloze-section">
      <!-- Título -->
      <div *ngIf="exercise.payload.title" class="exercise-header">
        <h2>{{ exercise.payload.title }}</h2>
      </div>

      <div class="instructions">
        <mat-icon>info</mat-icon>
        <p>For questions 1-8, read the text below and decide which answer (A, B, C or D) best fits each gap.</p>
      </div>

      <!-- Texto con huecos interactivos -->
      <div class="cloze-text-content">
        <p [innerHTML]="getMultipleChoiceClozeText(exercise.payload.text, exercise.payload.compact_choices)"></p>
      </div>

      <!-- Opciones para cada hueco -->
      <div class="choices-grid">
        <div *ngFor="let key of getObjectKeys(exercise.payload.compact_choices)" class="choice-group">
          <div class="choice-header">
            <span class="choice-number">{{ key }}</span>
          </div>
          <div class="choice-options">
            <button
              *ngFor="let choice of exercise.payload.compact_choices[key]; let i = index"
              mat-stroked-button
              [color]="userAnswers[key] === choice ? 'primary' : ''"
              [class.selected]="userAnswers[key] === choice && !showResults"
              [class.correct]="showResults && userAnswers[key] === choice && exercise.payload.compact_solutions[key] === choice"
              [class.incorrect]="showResults && userAnswers[key] === choice && exercise.payload.compact_solutions[key] !== choice"
              [disabled]="showResults"
              (click)="selectAnswer(key, choice)"
            >
              <span class="option-label">{{ getChoiceLabel(i) }}</span>
              <span class="option-text">{{ choice }}</span>
            </button>
          </div>
          <!-- Feedback -->
          <div *ngIf="showResults && userAnswers[key]" class="feedback">
            <div *ngIf="exercise.payload.compact_solutions[key] === userAnswers[key]" class="correct-feedback">
              <mat-icon>check_circle</mat-icon>
              <span>Correct!</span>
            </div>
            <div *ngIf="exercise.payload.compact_solutions[key] !== userAnswers[key]" class="incorrect-feedback">
              <mat-icon>cancel</mat-icon>
              <span>Incorrect. Correct answer: {{ exercise.payload.compact_solutions[key] }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults" class="results-summary">
        <mat-icon>{{ getMultipleChoiceClozeCorrectCount(exercise.payload.compact_solutions) === getObjectKeys(exercise.payload.compact_solutions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getMultipleChoiceClozeCorrectCount(exercise.payload.compact_solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.compact_solutions).length }}</strong> correct!
        </p>
      </div>
    </div>

    <!-- Open Cloze (texto con huecos numerados sin opciones, el usuario escribe la respuesta) -->
    <div *ngIf="!exercise.payload.audio && exercise.payload.text && exercise.payload.compact_solutions && !exercise.payload.compact_choices && !exercise.payload.compact_keywords && !exercise.payload.compact_challenges && !hasWordFormationPattern(exercise.payload.text)" class="open-cloze-section">
      <!-- Título -->
      <div *ngIf="exercise.payload.title" class="exercise-header">
        <h2>{{ exercise.payload.title }}</h2>
      </div>

      <div class="instructions">
        <mat-icon>info</mat-icon>
        <p>For questions 1-8, read the text below and think of the word which best fits each gap. Use only one word in each gap.</p>
      </div>

      <!-- Texto con huecos interactivos -->
      <div class="open-cloze-content">
        <p [innerHTML]="getOpenClozeText(exercise.payload.text, exercise.payload.compact_solutions)"></p>
      </div>

      <!-- Inputs para cada hueco -->
      <div class="gaps-grid">
        <div *ngFor="let key of getObjectKeys(exercise.payload.compact_solutions)" class="gap-input-group">
          <label class="gap-label">
            <span class="gap-number">{{ key }}</span>
            <mat-form-field appearance="outline" class="gap-field">
              <input
                matInput
                [(ngModel)]="userAnswers[key]"
                [disabled]="showResults"
                placeholder="Type your answer..."
                [class.correct-input]="showResults && isOpenClozeCorrect(key, exercise.payload.compact_solutions)"
                [class.incorrect-input]="showResults && userAnswers[key] && !isOpenClozeCorrect(key, exercise.payload.compact_solutions)"
              />
            </mat-form-field>
          </label>
          <!-- Feedback -->
          <div *ngIf="showResults && userAnswers[key]" class="feedback">
            <div *ngIf="isOpenClozeCorrect(key, exercise.payload.compact_solutions)" class="correct-feedback">
              <mat-icon>check_circle</mat-icon>
              <span>Correct!</span>
            </div>
            <div *ngIf="!isOpenClozeCorrect(key, exercise.payload.compact_solutions)" class="incorrect-feedback">
              <mat-icon>cancel</mat-icon>
              <span>Incorrect. Correct answer: <strong>{{ exercise.payload.compact_solutions[key] }}</strong></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults" class="results-summary">
        <mat-icon>{{ getOpenClozeCorrectCount(exercise.payload.compact_solutions) === getObjectKeys(exercise.payload.compact_solutions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getOpenClozeCorrectCount(exercise.payload.compact_solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.compact_solutions).length }}</strong> correct!
        </p>
      </div>
    </div>

    <!-- Word Formation (texto con huecos numerados y palabra base entre paréntesis) -->
    <div *ngIf="!exercise.payload.audio && exercise.payload.text && exercise.payload.compact_solutions && !exercise.payload.compact_choices && !exercise.payload.compact_keywords && !exercise.payload.compact_challenges && hasWordFormationPattern(exercise.payload.text)" class="word-formation-section">
      <!-- Título -->
      <div *ngIf="exercise.payload.title" class="exercise-header">
        <h2>{{ exercise.payload.title }}</h2>
      </div>

      <div class="instructions">
        <mat-icon>info</mat-icon>
        <p>For questions 1-8, read the text below. Use the word given in capitals at the end of some of the lines to form a word that fits in the gap in the same line.</p>
      </div>

      <!-- Texto con huecos interactivos -->
      <div class="word-formation-content">
        <p [innerHTML]="getWordFormationText(exercise.payload.text)"></p>
      </div>

      <!-- Lista de palabras base -->
      <div class="base-words-list">
        <h3>Words to use:</h3>
        <div class="words-grid">
          <div *ngFor="let item of getWordFormationBaseWords(exercise.payload.text)" class="word-item">
            <span class="word-number">{{ item.number }}</span>
            <span class="word-text">{{ item.word }}</span>
          </div>
        </div>
      </div>

      <!-- Inputs para cada hueco -->
      <div class="gaps-grid">
        <div *ngFor="let key of getObjectKeys(exercise.payload.compact_solutions)" class="gap-input-group">
          <label class="gap-label">
            <span class="gap-number">{{ key }}</span>
            <mat-form-field appearance="outline" class="gap-field">
              <input
                matInput
                [(ngModel)]="userAnswers[key]"
                [disabled]="showResults"
                placeholder="Type your answer..."
                [class.correct-input]="showResults && isOpenClozeCorrect(key, exercise.payload.compact_solutions)"
                [class.incorrect-input]="showResults && userAnswers[key] && !isOpenClozeCorrect(key, exercise.payload.compact_solutions)"
              />
            </mat-form-field>
          </label>
          <!-- Feedback -->
          <div *ngIf="showResults && userAnswers[key]" class="feedback">
            <div *ngIf="isOpenClozeCorrect(key, exercise.payload.compact_solutions)" class="correct-feedback">
              <mat-icon>check_circle</mat-icon>
              <span>Correct!</span>
            </div>
            <div *ngIf="!isOpenClozeCorrect(key, exercise.payload.compact_solutions)" class="incorrect-feedback">
              <mat-icon>cancel</mat-icon>
              <span>Incorrect. Correct answer: <strong>{{ exercise.payload.compact_solutions[key] }}</strong></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Resultados -->
      <div *ngIf="showResults" class="results-summary">
        <mat-icon>{{ getOpenClozeCorrectCount(exercise.payload.compact_solutions) === getObjectKeys(exercise.payload.compact_solutions).length ? 'check_circle' : 'pending' }}</mat-icon>
        <p>
          You got <strong>{{ getOpenClozeCorrectCount(exercise.payload.compact_solutions) }}</strong> out of
          <strong>{{ getObjectKeys(exercise.payload.compact_solutions).length }}</strong> correct!
        </p>
      </div>
    </div>

    <!-- Listening / Reading / Use of English (Generic) -->
    <div
      *ngIf="!isGrammarTest() && !isSpeaking() && !isWriting() && !isMatching() && !exercise.payload.people && !exercise.payload.audio && !exercise.payload.compact_keywords && !exercise.payload.compact_choices && !(exercise.payload.text && exercise.payload.compact_solutions && !exercise.payload.compact_challenges) && exercise.payload"
      class="generic-exercise"
    >
      <!-- Título y subtítulo -->
      <div *ngIf="exercise.payload.title" class="exercise-header">
        <h2>{{ exercise.payload.title }}</h2>
        <p *ngIf="exercise.payload.subtitle" class="subtitle">{{ exercise.payload.subtitle }}</p>
      </div>

      <!-- Textos (para Cross Matching y similares) -->
      <div *ngIf="exercise.payload.texts && exercise.payload.texts.length > 0" class="texts-section">
        <div *ngFor="let textItem of exercise.payload.texts" class="text-item">
          <h3 *ngIf="textItem.title">{{ textItem.title }}</h3>
          <p class="text-content">{{ textItem.text }}</p>
        </div>
      </div>

      <!-- Texto único (para otros tipos) -->
      <div *ngIf="exercise.payload.text && !exercise.payload.texts && !hasMissingGaps(exercise.payload.text)" class="main-text">
        <p class="text-content" style="white-space: pre-line;">{{ formatTextWithBreaks(exercise.payload.text) }}</p>
      </div>

      <!-- Missing Paragraphs / Missing Sentences (texto con gaps y choices) -->
      <div *ngIf="exercise.payload.text && hasMissingGaps(exercise.payload.text) && exercise.payload.choices" class="missing-paragraphs">
        <!-- Texto continuo con gaps inline -->
        <div class="continuous-text">
          <ng-container *ngFor="let segment of getTextSegments(exercise.payload.text)">
            <span *ngIf="segment.type === 'text'" class="text-part">{{ segment.content }} </span>
            <span
              *ngIf="segment.type === 'gap'"
              class="inline-gap"
              [class.filled]="userAnswers[segment.index]"
              [class.selected]="selectedGap === segment.index"
              [class.correct]="showResults && checkGapAnswer(segment.index, exercise)"
              [class.incorrect]="showResults && userAnswers[segment.index] && !checkGapAnswer(segment.index, exercise)"
              (click)="!showResults && selectGap(segment.index)"
            >
              <span class="gap-bracket">[</span>
              <span class="gap-number">{{ segment.index }}</span>
              <span *ngIf="userAnswers[segment.index]" class="gap-answer">: {{ getDisplayKey(userAnswers[segment.index]) }}</span>
              <span *ngIf="showResults && userAnswers[segment.index] && !checkGapAnswer(segment.index, exercise)" class="correct-answer-indicator">
                → {{ getCorrectGapAnswer(segment.index, exercise) }}
              </span>
              <span class="gap-bracket">]</span>
            </span>
          </ng-container>
        </div>

        <!-- Instrucción -->
        <div class="instruction" *ngIf="!showResults">
          <mat-icon>info</mat-icon>
          <span *ngIf="!selectedGap">Click on a gap [number] above to select it</span>
          <span *ngIf="selectedGap" class="highlight">Gap {{ selectedGap }} selected → Now click a paragraph below</span>
        </div>

        <!-- Párrafos disponibles -->
        <div class="available-paragraphs">
          <h3>Available Options:</h3>
          <div class="paragraphs-list">
            <div
              *ngFor="let choice of shuffledChoices"
              class="paragraph-card"
              [class.used]="isChoiceUsed(choice.key)"
              [class.clickable]="selectedGap && !showResults"
              (click)="!showResults && selectedGap && assignParagraphToGap(choice.key)"
            >
              <div class="paragraph-header">
                <span class="paragraph-label">{{ choice.displayKey || choice.key }}</span>
                <span *ngIf="isChoiceUsed(choice.key)" class="used-in">
                  ✓ Gap {{ getGapForChoice(choice.key) }}
                </span>
              </div>
              <p class="paragraph-text">{{ choice.value }}</p>
            </div>
          </div>
        </div>

        <!-- Resultados -->
        <div *ngIf="showResults" class="results-summary">
          <mat-icon>{{ getCorrectGapsCount(exercise) === getTotalGaps(exercise.payload.text) ? 'check_circle' : 'pending' }}</mat-icon>
          <p>
            You got <strong>{{ getCorrectGapsCount(exercise) }}</strong> out of
            <strong>{{ getTotalGaps(exercise.payload.text) }}</strong> correct!
          </p>
        </div>
      </div>

      <!-- Signs (imágenes con preguntas de opción múltiple) -->
      <div *ngIf="(exercise.payload.compact_images || exercise.payload.images) && exercise.payload.compact_choices" class="signs-section">
        <h3>Look at the signs and choose the correct answer</h3>
        <div *ngFor="let key of getObjectKeys(exercise.payload.compact_choices)" class="sign-item">
          <div class="sign-image">
            <img
              [src]="exercise.payload.compact_images ? exercise.payload.compact_images[key] : getImageByKey(exercise.payload.images, key)"
              [alt]="'Sign ' + key"
              (error)="onImageError($event)"
            />
          </div>

          <div class="sign-question">
            <p class="question-text">
              <strong>{{ key }}.</strong> {{ getSignQuestion(exercise.payload.compact_choices[key]) }}
            </p>

            <!-- Opciones de respuesta -->
            <div class="answer-selector vertical">
              <button
                *ngFor="let choice of getSignChoices(exercise.payload.compact_choices[key]); let i = index"
                mat-stroked-button
                [color]="userAnswers[key] === choice ? 'primary' : ''"
                [class.selected]="userAnswers[key] === choice && !showResults"
                [class.correct]="showResults && userAnswers[key] === choice && isCorrectAnswer(key, exercise.payload.compact_solutions)"
                [class.incorrect]="showResults && userAnswers[key] === choice && !isCorrectAnswer(key, exercise.payload.compact_solutions)"
                [disabled]="showResults"
                (click)="selectAnswer(key, choice)"
              >
                <span class="choice-label">{{ getChoiceLabel(i) }}.</span>
                <span class="choice-text">{{ choice }}</span>
              </button>
            </div>

            <!-- Mostrar respuesta correcta si está mal -->
            <div *ngIf="showResults && !isCorrectAnswer(key, exercise.payload.compact_solutions) && exercise.payload.compact_solutions && exercise.payload.compact_solutions[key]" class="correct-answer">
              <mat-icon>info</mat-icon>
              <span>Correct answer: {{ exercise.payload.compact_solutions[key] }}</span>
            </div>
          </div>
        </div>

        <!-- Resultados -->
        <div *ngIf="showResults && exercise.payload.compact_solutions" class="results-summary">
          <mat-icon>{{ getCorrectCount(exercise.payload.compact_solutions) === getObjectKeys(exercise.payload.compact_choices).length ? 'check_circle' : 'pending' }}</mat-icon>
          <p>
            You got <strong>{{ getCorrectCount(exercise.payload.compact_solutions) }}</strong> out of
            <strong>{{ getObjectKeys(exercise.payload.compact_choices).length }}</strong> correct!
          </p>
        </div>
      </div>

      <!-- Preguntas compactas (Long Text con compact_questions y compact_answers) -->
      <div *ngIf="exercise.payload.compact_questions && exercise.payload.compact_answers" class="questions-section">
        <h3>Questions</h3>
        <div *ngFor="let key of getObjectKeys(exercise.payload.compact_questions)" class="question-item">
          <p class="question">
            <strong>{{ key }}.</strong> {{ exercise.payload.compact_questions[key] }}
          </p>

          <!-- Selector de respuesta interactivo con opciones múltiples -->
          <div class="answer-selector vertical">
            <button
              *ngFor="let choice of getShuffledAnswers(key); let i = index"
              mat-stroked-button
              [color]="userAnswers[key] === choice ? 'primary' : ''"
              [class.selected]="userAnswers[key] === choice && !showResults"
              [class.correct]="showResults && userAnswers[key] === choice && isCorrectAnswer(key, exercise.payload.compact_solutions)"
              [class.incorrect]="showResults && userAnswers[key] === choice && !isCorrectAnswer(key, exercise.payload.compact_solutions)"
              [disabled]="showResults"
              (click)="selectAnswer(key, choice)"
            >
              <span class="choice-label">{{ getChoiceLabel(i) }}.</span>
              <span class="choice-text">{{ choice }}</span>
            </button>
          </div>

          <!-- Mostrar respuesta correcta si está mal -->
          <div *ngIf="showResults && !isCorrectAnswer(key, exercise.payload.compact_solutions) && exercise.payload.compact_solutions && exercise.payload.compact_solutions[key]" class="correct-answer">
            <mat-icon>info</mat-icon>
            <span>Correct answer: {{ exercise.payload.compact_solutions[key] }}</span>
          </div>
        </div>

        <!-- Resultados -->
        <div *ngIf="showResults && exercise.payload.compact_solutions" class="results-summary">
          <mat-icon>{{ getCorrectCount(exercise.payload.compact_solutions) === getObjectKeys(exercise.payload.compact_questions).length ? 'check_circle' : 'pending' }}</mat-icon>
          <p>
            You got <strong>{{ getCorrectCount(exercise.payload.compact_solutions) }}</strong> out of
            <strong>{{ getObjectKeys(exercise.payload.compact_questions).length }}</strong> correct!
          </p>
        </div>
      </div>

      <!-- Preguntas (formato objeto con keys numéricas, ej: Cross Matching) -->
      <div *ngIf="exercise.payload.questions && !isArray(exercise.payload.questions) && !exercise.payload.compact_questions" class="questions-section">
        <h3>Questions</h3>
        <div *ngFor="let key of getObjectKeys(exercise.payload.questions)" class="question-item">
          <p class="question">
            <strong>{{ key }}.</strong> {{ exercise.payload.questions[key] }}
          </p>

          <!-- Selector de respuesta interactivo -->
          <div class="answer-selector">
            <button
              *ngFor="let choice of exercise.payload.choices"
              mat-stroked-button
              [color]="userAnswers[key] === choice ? 'primary' : ''"
              [class.selected]="userAnswers[key] === choice && !showResults"
              [class.correct]="showResults && userAnswers[key] === choice && isCorrectAnswer(key, exercise.payload.solutions)"
              [class.incorrect]="showResults && userAnswers[key] === choice && !isCorrectAnswer(key, exercise.payload.solutions)"
              [disabled]="showResults"
              (click)="selectAnswer(key, choice)"
            >
              {{ choice }}
            </button>
          </div>

          <!-- Mostrar respuesta correcta si está mal -->
          <div *ngIf="showResults && !isCorrectAnswer(key, exercise.payload.solutions) && exercise.payload.solutions[key]" class="correct-answer">
            <mat-icon>info</mat-icon>
            <span>Correct answer: {{ exercise.payload.solutions[key] }}</span>
          </div>
        </div>

        <!-- Choices/Opciones disponibles (solo mostrar si no está en modo interactivo) -->
        <div *ngIf="exercise.payload.choices && isArray(exercise.payload.choices) && exercise.payload.choices.length > 0" class="choices-info">
          <h4>Available Choices:</h4>
          <div class="choices-list">
            <span *ngFor="let choice of exercise.payload.choices; let last = last" class="choice-badge">
              {{ choice }}<span *ngIf="!last">, </span>
            </span>
          </div>
        </div>

        <!-- Resultados -->
        <div *ngIf="showResults && exercise.payload.solutions" class="results-summary">
          <mat-icon>{{ getCorrectCount(exercise.payload.solutions) === getObjectKeys(exercise.payload.questions).length ? 'check_circle' : 'pending' }}</mat-icon>
          <p>
            You got <strong>{{ getCorrectCount(exercise.payload.solutions) }}</strong> out of
            <strong>{{ getObjectKeys(exercise.payload.questions).length }}</strong> correct!
          </p>
        </div>
      </div>

      <!-- Fallback: mostrar JSON crudo si no encaja en ningún patrón -->
      <details class="raw-data" *ngIf="isAdmin">
        <summary>View Raw Data</summary>
        <pre>{{ formatJson(exercise.payload) }}</pre>
      </details>
    </div>

    <!-- Controles globales -->
    <div class="exercise-controls">
      <!-- Botón para verificar respuestas (Missing Paragraphs / Missing Sentences) -->
      <button
        *ngIf="exercise.payload.text && hasMissingGaps(exercise.payload.text) && exercise.payload.choices && !exercise.payload.compact_choices && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Matching) -->
      <button
        *ngIf="exercise.payload.people && exercise.payload.texts && exercise.payload.solutions && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Listening Matching) -->
      <button
        *ngIf="exercise.payload.audio && exercise.payload.sentences && exercise.payload.solutions && !exercise.payload.sentences_1 && !exercise.payload.sentences_2 && !exercise.payload.base_file_path && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Listening Pictures) -->
      <button
        *ngIf="exercise.payload.audio && exercise.payload.base_file_path && exercise.payload.questions && exercise.payload.choices && exercise.payload.solutions && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Key Word Transformations) -->
      <button
        *ngIf="!exercise.payload.audio && exercise.payload.compact_sentences && exercise.payload.compact_keywords && exercise.payload.compact_challenges && exercise.payload.compact_solutions && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Multiple Choice Cloze) -->
      <button
        *ngIf="!exercise.payload.audio && exercise.payload.text && exercise.payload.compact_choices && exercise.payload.compact_solutions && !exercise.payload.compact_keywords && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Open Cloze) -->
      <button
        *ngIf="!exercise.payload.audio && exercise.payload.text && exercise.payload.compact_solutions && !exercise.payload.compact_choices && !exercise.payload.compact_keywords && !exercise.payload.compact_challenges && !hasWordFormationPattern(exercise.payload.text) && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Word Formation) -->
      <button
        *ngIf="!exercise.payload.audio && exercise.payload.text && exercise.payload.compact_solutions && !exercise.payload.compact_choices && !exercise.payload.compact_keywords && !exercise.payload.compact_challenges && hasWordFormationPattern(exercise.payload.text) && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Signs) -->
      <button
        *ngIf="(exercise.payload.compact_images || exercise.payload.images) && exercise.payload.compact_choices && exercise.payload.compact_solutions && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Listening Extracts) -->
      <button
        *ngIf="exercise.payload.audio && exercise.payload.questions && exercise.payload.choices && exercise.payload.headline && exercise.payload.headline.includes('//') && !exercise.payload.base_file_path && exercise.payload.solutions && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Listening Multiple Choice) -->
      <button
        *ngIf="exercise.payload.audio && exercise.payload.questions && exercise.payload.choices && (!exercise.payload.headline || !exercise.payload.headline.includes('//')) && !exercise.payload.base_file_path && exercise.payload.solutions && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Listening Gapped Text) -->
      <button
        *ngIf="exercise.payload.audio && exercise.payload.text && exercise.payload.solutions && !exercise.payload.questions && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (Listening Multiple Matching) -->
      <button
        *ngIf="exercise.payload.audio && exercise.payload.sentences_1 && exercise.payload.sentences_2 && exercise.payload.solutions_1 && exercise.payload.solutions_2 && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (ejercicios interactivos con compact_questions) -->
      <button
        *ngIf="exercise.payload.compact_questions && exercise.payload.compact_solutions && !exercise.payload.compact_choices && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para verificar respuestas (ejercicios interactivos Cross Matching) -->
      <button
        *ngIf="exercise.payload.questions && !isArray(exercise.payload.questions) && !exercise.payload.compact_questions && !exercise.payload.audio && exercise.payload.solutions && !showResults"
        mat-raised-button
        color="primary"
        (click)="checkAnswers()"
        [disabled]="getObjectKeys(userAnswers).length === 0"
      >
        <mat-icon>check</mat-icon>
        Check Answers
      </button>

      <!-- Botón para reintentar -->
      <button
        *ngIf="showResults && !isGrammarTest()"
        mat-raised-button
        color="accent"
        (click)="resetExercise()"
      >
        <mat-icon>refresh</mat-icon>
        Try Again
      </button>

      <!-- Botón para verificar respuestas (Grammar Tests) -->
      <button
        mat-raised-button
        color="primary"
        (click)="showResults = true"
        *ngIf="isGrammarTest() && !showResults"
      >
        <mat-icon>check_circle</mat-icon>
        Check Answers
      </button>

      <!-- Botón para reintentar (Grammar Tests) -->
      <button
        mat-raised-button
        color="accent"
        (click)="showResults = false; userAnswers = {}"
        *ngIf="isGrammarTest() && showResults"
      >
        <mat-icon>refresh</mat-icon>
        Try Again
      </button>
    </div>

    <!-- Raw Data global (fallback para cualquier tipo de ejercicio si es admin) -->
    <details class="raw-data" *ngIf="isAdmin && exercise$ | async as exercise" style="margin-top: 32px;">
      <summary>View Raw Data</summary>
      <pre>{{ formatJson(exercise.payload) }}</pre>
    </details>
  </div>
</div>
